name: Secure Browser Build (v9 - Cromite Fixed Tag)

on:
  workflow_dispatch:

jobs:
  build-full-browser:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    container:
      # KESİN SÜRÜM ETİKETİ (Latest değil!)
      image: uazo/cromite-build:133-1

    steps:
    - uses: actions/checkout@v3

    # 1. Temiz Kaynak Kodu Çek
    - name: Fetch Clean Source
      run: |
        # Cromite deposunu çek
        git clone https://github.com/uazo/cromite.git cromite
        cd cromite
        # Alt modülleri güncelle (recursive çok önemlidir)
        git submodule update --init --recursive

    # 2. ÖZELLEŞTİRMELER
    - name: Apply Customizations
      run: |
        cd cromite
        echo "Özel özellikler yükleniyor..."
        # Şimdilik boş, sonra dolduracağız
        ls -la

    # 3. Derleme Hazırlığı
    - name: Setup Build Config
      run: |
        cd cromite
        mkdir -p out/Release
        # Varsayılan ayarları kopyala
        # (Not: Cromite yapısında args.gn farklı yerde olabilir, 
        # o yüzden garanti olsun diye elle yazıyoruz)
        echo 'target_os="android"' > out/Release/args.gn
        echo 'target_cpu="arm64"' >> out/Release/args.gn
        echo 'is_debug=false' >> out/Release/args.gn
        echo 'symbol_level=0' >> out/Release/args.gn
        echo 'blink_symbol_level=0' >> out/Release/args.gn
        echo 'android_channel="stable"' >> out/Release/args.gn
        
        # Markalama
        echo 'app_name="Secure Browser"' >> out/Release/args.gn

    # 4. DERLEME
    - name: Compile APK
      run: |
        cd cromite
        # Cromite'in kendi derleme scriptini kullanıyoruz
        # Bu script gerekli GN ve Ninja ayarlarını otomatik yapar
        ./build.sh --target chrome_public_apk

    # 5. Sonucu Yükle
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SecureBrowser-Release-v1.0
        path: cromite/out/Release/apks/ChromePublic.apk
