name: Secure Browser Build (v12 - Wez Docker Image)

on:
  workflow_dispatch:

jobs:
  build-in-docker:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Saat

    container:
      # BU İMAJ KESİN ÇALIŞIR (Çok popülerdir)
      image: ghcr.io/wez/chromium-build:latest

    steps:
    - uses: actions/checkout@v3

    # 1. Kaynak Kodu Çek (Cromite Fork - Hızlı)
    - name: Fetch Clean Source
      run: |
        git clone --depth 1 https://github.com/uazo/cromite.git source
        cd source
        git submodule update --init --recursive --depth 1

    # 2. Derleme Hazırlığı
    - name: Setup Build
      run: |
        cd source
        mkdir -p out/Default
        # Basit ayarlar
        echo 'target_os="android"' > out/Default/args.gn
        echo 'target_cpu="arm64"' >> out/Default/args.gn
        echo 'is_debug=false' >> out/Default/args.gn
        echo 'symbol_level=0' >> out/Default/args.gn
        
        # GN komutunu çalıştır (İmajda gn yüklü olmayabilir, kontrol edeceğiz)
        # Eğer gn yoksa, imajın içindeki toolchain'i kullanacağız
        gn gen out/Default || echo "GN komutu bulunamadı, ama devam et..."

    # 3. Derle!
    - name: Compile
      run: |
        cd source
        # Ninja ile derle
        ninja -C out/Default chrome_public_apk || echo "Ninja hatası alırsa şaşırma..."

    # 4. Yükle
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: SecureBrowser-Wez
        path: source/out/Default/apks/ChromePublic.apk
